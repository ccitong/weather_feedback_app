<form [formGroup]="feedbackForm" (ngSubmit)="onSubmit()" class="feedback-form">
  <!-- Postal Code and Municipality Section -->
  <div class="location-section">
    <mat-form-field appearance="outline">
      <mat-label>Postal Code</mat-label>
      <input matInput
             formControlName="postalCode"
             placeholder="A1A 1A1"
             maxlength="7"
             (keyup)="onPostalCodeKeyUp($event)">
      <mat-hint align="end">{{remainingChars}} characters remaining</mat-hint>
      <mat-icon matSuffix 
                class="enter-icon" 
                matTooltip="Press Enter or click to submit"
                (click)="onEnterIconClick()">keyboard_return</mat-icon>
      <mat-error *ngIf="feedbackForm.get('postalCode')?.errors?.['required']">
        Postal code is required
      </mat-error>
      <mat-error *ngIf="feedbackForm.get('postalCode')?.errors?.['pattern']">
        Please enter a valid Canadian postal code (e.g., A1A 1A1)
      </mat-error>
    </mat-form-field>

    <button mat-raised-button
            color="primary"
            type="button"
            [disabled]="isGettingLocation"
            (click)="getLocationPostalCode()">
      <mat-icon>my_location</mat-icon>
      {{ isGettingLocation ? 'Getting Location...' : 'Get My Location' }}
    </button>
  </div>

  <mat-form-field appearance="outline">
    <mat-label>Municipality</mat-label>
    <input matInput
           formControlName="municipality"
           placeholder="City/Town"
           [readonly]="true">
    <mat-spinner matSuffix
                 diameter="20"
                 *ngIf="isLoadingMunicipality">
    </mat-spinner>
    <mat-error *ngIf="feedbackForm.get('municipality')?.errors?.['required']">
      Municipality is required
    </mat-error>
  </mat-form-field>

  <!-- Weather Information and Feedback -->
  <div class="weather-section">
    <!-- Current Location Weather -->
    <mat-card class="weather-card" *ngIf="currentWeather">
      <mat-card-header>
        <div *ngIf="currentWeather.condition" class="weather-icon-container">
          <img [src]="currentWeather.condition.icon" 
               [alt]="currentWeather.condition.text"
               class="weather-icon">
        </div>
        <mat-card-title>Current Location Weather</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p><strong>Condition:</strong> {{currentWeather.condition?.text || 'N/A'}}</p>
        <p><strong>Temperature:</strong> {{currentWeather.temp_c !== undefined ? currentWeather.temp_c + '°C' : 'N/A'}}</p>
        <p><strong>UV Index:</strong> {{currentWeather.uv !== undefined ? currentWeather.uv : 'N/A'}}</p>
      </mat-card-content>
    </mat-card>

    <!-- All Areas Weather -->
    <mat-expansion-panel class="all-areas-weather">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <h2>Weather for All Areas</h2>
        </mat-panel-title>
        <mat-panel-description>
          Click to expand and select a location to give feedback
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="weather-grid" *ngIf="!isLoadingWeather">
        <mat-card class="weather-card" 
                 *ngFor="let weather of multipleWeatherData"
                 [class.selected]="isCardSelected(weather)"
                 (click)="selectWeatherCard(weather)">
          <div class="selected-indicator" *ngIf="isCardSelected(weather)">
            <div class="triangle"></div>
          </div>
          <mat-card-header>
            <div *ngIf="weather.current.condition" class="weather-icon-container">
              <img [src]="weather.current.condition.icon" 
                   [alt]="weather.current.condition.text"
                   class="weather-icon">
            </div>
            <mat-card-title>{{getAreaForPostalCode(weather.postalCode)}}</mat-card-title>
            <mat-card-subtitle>{{weather.postalCode}}</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <p><strong>Condition:</strong> {{weather.current.condition?.text || 'N/A'}}</p>
            <p><strong>Temperature:</strong> {{weather.current.temp_c !== undefined ? weather.current.temp_c + '°C' : 'N/A'}}</p>
            <p><strong>UV Index:</strong> {{weather.current.uv !== undefined ? weather.current.uv : 'N/A'}}</p>
          </mat-card-content>
        </mat-card>
      </div>
      <mat-spinner *ngIf="isLoadingWeather" class="weather-spinner"></mat-spinner>
    </mat-expansion-panel>

    <!-- Feedback Buttons -->
    <div class="feedback-section">
      <div class="feedback-buttons">
        <button mat-raised-button 
                type="button"
                class="mat-mdc-raised-button green-button"
                [class.selected]="selectedFeedback === 'positive'"
                (click)="setWeatherFeedback('positive')"
                matTooltip="No action required for this weather">
          <mat-icon>check_circle</mat-icon>
          No Action Required
        </button>
        <button mat-raised-button 
                type="button"
                class="mat-mdc-raised-button red-button"
                [class.selected]="selectedFeedback === 'negative'"
                (click)="setWeatherFeedback('negative')"
                matTooltip="Action required for this weather">
          <mat-icon>warning</mat-icon>
          Action Required
        </button>
      </div>
      <p class="feedback-reminder">Please select whether action is required for this weather condition</p>
      <mat-error *ngIf="feedbackForm.get('weatherFeedback')?.errors?.['required'] && feedbackForm.get('weatherFeedback')?.touched">
        Please select your weather feedback
      </mat-error>
    </div>
  </div>

  <!-- Date and Time Section -->
  <mat-form-field appearance="outline">
    <mat-label>Date and Time of Interaction</mat-label>
    <input matInput
           type="datetime-local"
           formControlName="dateOfInteraction"
           [max]="currentDateTime"
           [min]="minDateTime">
    <mat-error *ngIf="feedbackForm.get('dateOfInteraction')?.errors?.['required']">
      Date and time is required
    </mat-error>
  </mat-form-field>

  <!-- Feedback Section -->
  <mat-form-field appearance="outline">
    <mat-label>Additional Feedback (Optional)</mat-label>
    <textarea matInput
              formControlName="feedback"
              placeholder="Enter any additional feedback here"
              rows="4">
    </textarea>
  </mat-form-field>

  <!-- Submit Button -->
  <div class="submit-section">
    <button mat-raised-button
            color="primary"
            type="submit"
            [disabled]="!feedbackForm.valid || isSubmitting"
            (click)="onSubmit()">
      {{ isSubmitting ? 'Submitting...' : 'Submit Feedback' }}
    </button>

    <!-- Success Message -->
    <div class="success-message" *ngIf="submitSuccess">
      <mat-icon>check_circle</mat-icon>
      Feedback submitted successfully!
    </div>

    <!-- Error Message -->
    <div class="error-message" *ngIf="submitError">
      <mat-icon>error</mat-icon>
      {{ submitError }}
    </div>
  </div>
</form>
